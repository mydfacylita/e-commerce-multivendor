generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextIndex", "fullTextSearch"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id               String            @id @default(cuid())
  name             String?
  email            String            @unique
  emailVerified    DateTime?
  image            String?
  password         String?
  phone            String?
  cpf              String?
  role             Role              @default(USER)
  workForSellerId  String?
  employeeRole     EmployeeRole?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  addresses        Address[]
  aliexpressAuth   AliExpressAuth?
  cartItems        CartItem[]
  mercadoLivreAuth MercadoLivreAuth?
  orders           Order[]
  seller           Seller?           @relation("SellerOwner")
  shopeeAuth       ShopeeAuth?
  tiktokShopAuth   TikTokShopAuth?
  workForSeller    Seller?           @relation("SellerEmployees", fields: [workForSellerId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([workForSellerId])
  @@index([role])
  @@index([email, role])
  @@index([createdAt])
  @@map("user")
}

model Address {
  id            String   @id @default(cuid())
  userId        String
  label         String?
  recipientName String?
  street        String
  complement    String?
  neighborhood  String?
  city          String
  state         String
  zipCode       String
  phone         String?
  cpf           String?
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isDefault])
  @@map("address")
}

model Seller {
  id                     String                        @id @default(cuid())
  userId                 String                        @unique
  storeName              String
  storeSlug              String                        @unique
  storeDescription       String?                       @db.Text
  storeLogo              String?
  storeBanner            String?
  sellerType             SellerType
  cpf                    String?
  rg                     String?
  dataNascimento         DateTime?
  cnpj                   String?
  razaoSocial            String?
  nomeFantasia           String?
  inscricaoEstadual      String?
  cep                    String?
  endereco               String?
  numero                 String?
  complemento            String?
  bairro                 String?
  cidade                 String?
  estado                 String?
  banco                  String?
  agencia                String?
  conta                  String?
  tipoConta              String?
  chavePix               String?
  commission             Float                         @default(10)
  status                 SellerStatus                  @default(PENDING)
  createdAt              DateTime                      @default(now())
  updatedAt              DateTime                      @updatedAt
  balance                Float                         @default(0)
  totalEarned            Float                         @default(0)
  totalWithdrawn         Float                         @default(0)
  orders                 Order[]                       @relation("SellerOrders")
  ordersSold             Order[]                       @relation("SellerSoldOrders")
  products               Product[]
  user                   User                          @relation("SellerOwner", fields: [userId], references: [id], onDelete: Cascade)
  marketplaceCredentials SellerMarketplaceCredential[]
  subscription           Subscription?
  employees              User[]                        @relation("SellerEmployees")
  withdrawals            Withdrawal[]

  @@index([status])
  @@index([storeSlug])
  @@index([userId])
  @@map("seller")
}

model SellerMarketplaceCredential {
  id                 String    @id @default(cuid())
  sellerId           String
  marketplace        String
  mlClientId         String?
  mlClientSecret     String?
  mlAccessToken      String?   @db.Text
  mlRefreshToken     String?   @db.Text
  mlUserId           String?
  mlExpiresAt        DateTime?
  aliAppKey          String?
  aliAppSecret       String?
  aliTrackingId      String?
  aliAccessToken     String?   @db.Text
  shopeePartnerId    Int?
  shopeePartnerKey   String?
  shopeeAccessToken  String?   @db.Text
  shopeeRefreshToken String?   @db.Text
  shopeeShopId       Int?
  shopeeMerchantName String?
  shopeeRegion       String?
  shopeeExpiresAt    DateTime?
  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  seller             Seller    @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@unique([sellerId, marketplace])
  @@index([sellerId])
  @@map("sellermarketplacecredential")
}

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  image       String?
  parentId    String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]

  @@index([parentId])
  @@map("category")
}

model Product {
  id                       String               @id @default(cuid())
  name                     String
  slug                     String               @unique
  description              String?              @db.Text
  price                    Float
  comparePrice             Float?
  costPrice                Float?
  shippingCost             Float?
  taxCost                  Float?
  totalCost                Float?
  margin                   Float?
  isDropshipping           Boolean              @default(false)
  dropshippingCommission   Float?
  images                   String               @db.Text
  stock                    Int                  @default(0)
  featured                 Boolean              @default(false)
  categoryId               String
  sellerId                 String?
  supplierId               String?
  supplierSku              String?
  supplierUrl              String?              @db.Text
  specifications           String?              @db.Text
  variants                 String?              @db.Text
  attributes               String?              @db.Text
  sizes                    String?              @db.Text
  sizeType                 String?
  sizeCategory             String?
  gtin                     String?
  brand                    String?
  model                    String?
  color                    String?
  mpn                      String?
  technicalSpecs           String?              @db.Text
  createdAt                DateTime             @default(now())
  updatedAt                DateTime             @updatedAt
  availableForDropship     Boolean              @default(true)
  isChoiceProduct          Boolean              @default(false)
  lastSyncAt               DateTime?
  supplierRating           Float?
  supplierShippingSpeed    Float?
  supplierStock            Int?
  supplierStoreId          String?
  supplierStoreName        String?
  active                   Boolean              @default(true)
  bookAuthor               String?
  bookGenre                String?
  bookIsbn                 String?
  bookPublisher            String?
  bookTitle                String?
  weight                   Float?
  weightWithPackage        Float?
  length                   Float?
  width                    Float?
  height                   Float?
  lengthWithPackage        Float?
  widthWithPackage         Float?
  heightWithPackage        Float?
  acceptsCreditCard        Boolean?
  installmentsFreeInterest Int?
  maxInstallments          Int?
  cartItems                CartItem[]
  marketplaceListings      MarketplaceListing[]
  orderItems               OrderItem[]
  category                 Category             @relation(fields: [categoryId], references: [id])
  seller                   Seller?              @relation(fields: [sellerId], references: [id])
  supplier                 Supplier?            @relation(fields: [supplierId], references: [id])

  @@index([categoryId])
  @@index([sellerId])
  @@index([supplierId])
  @@index([featured])
  @@index([isDropshipping])
  @@index([active])
  @@index([categoryId, featured])
  @@index([categoryId, active])
  @@index([sellerId, active])
  @@index([isDropshipping, availableForDropship])
  @@index([createdAt])
  @@map("product")
}

model Supplier {
  id         String    @id @default(cuid())
  name       String
  email      String    @unique
  phone      String?
  website    String?
  apiUrl     String?
  apiKey     String?
  type       String    @default("aliexpress") @db.VarChar(255)
  isActive   Boolean   @default(true)
  commission Float     @default(0)
  active     Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  products   Product[]

  @@map("supplier")
}

model CartItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
  @@map("cartitem")
}

model Order {
  id                 String      @id @default(cuid())
  userId             String?
  parentOrderId      String?
  status             OrderStatus @default(PENDING)
  total              Float
  profit             Float?
  shippingAddress    String      @db.Text
  paymentIntentId    String?
  supplierOrderId    String?
  trackingCode       String?
  marketplaceName    String?
  marketplaceOrderId String?     @unique
  sentToSupplier     Boolean     @default(false)
  sentToSupplierAt   DateTime?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  buyerEmail         String?
  buyerName          String?
  buyerPhone         String?
  buyerCpf           String?
  paymentMethod      String?
  shippingCost       Float?
  buyerMessages      String?     @db.Text
  cancelReason       String?
  commissionAmount   Float?
  commissionRate     Float?
  sellerRevenue      Float?
  soldBySellerId     String?
  sellerId           String?
  paymentApprovedAt  DateTime?
  paymentDetails     String?     @db.LongText
  paymentId          String?
  paymentStatus      String?
  paymentType        String?
  couponCode         String?
  discountAmount     Float?
  subtotal           Float?
  deliveryDays       Int?
  expeditionNotes    String?     @db.Text
  labelPrintedAt     DateTime?
  packagingBoxId     String?
  packedAt           DateTime?
  packedBy           String?
  separatedAt        DateTime?
  separatedBy        String?
  shippedAt          DateTime?
  shippedBy          String?
  shippingCarrier    String?
  shippingLabel      String?     @db.Text
  shippingLabelType  String?
  shippingMethod     String?
  shippingService    String?
  fraudScore         Int?
  fraudReasons       String?     @db.Text
  fraudStatus        String?     @db.VarChar(50)
  fraudCheckedAt     DateTime?   @db.DateTime(0)
  fraudCheckedBy     String?     @db.VarChar(255)
  fraudNotes         String?     @db.Text
  ipAddress          String?     @db.VarChar(100)
  userAgent          String?     @db.Text
  seller             Seller?     @relation("SellerOrders", fields: [sellerId], references: [id])
  soldBySeller       Seller?     @relation("SellerSoldOrders", fields: [soldBySellerId], references: [id])
  user               User?       @relation(fields: [userId], references: [id])
  items              OrderItem[]
  refunds            Refund[]

  @@index([userId])
  @@index([sellerId])
  @@index([soldBySellerId])
  @@index([status])
  @@index([createdAt])
  @@index([sellerId, status])
  @@index([userId, status])
  @@index([marketplaceOrderId])
  @@index([parentOrderId])
  @@index([packagingBoxId])
  @@index([shippingMethod])
  @@index([fraudScore], map: "idx_fraud_score")
  @@index([fraudStatus], map: "idx_fraud_status")
  @@map("order")
}

model OrderItem {
  id               String       @id @default(cuid())
  orderId          String
  productId        String
  quantity         Int
  price            Float
  createdAt        DateTime     @default(now())
  itemType         ItemType     @default(STOCK)
  commissionAmount Float?
  commissionRate   Float?
  sellerId         String?
  sellerRevenue    Float?
  supplierOrderId  String?
  supplierStatus   String?
  supplierCost     Float?
  trackingCode     String?
  selectedSize     String?
  selectedColor    String?
  refundedAt       DateTime?
  order            Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product          Product      @relation(fields: [productId], references: [id])
  refundItems      RefundItem[]

  @@index([orderId])
  @@index([productId])
  @@index([itemType])
  @@index([sellerId])
  @@map("orderitem")
}

model MercadoLivreAuth {
  id           String   @id @default(cuid())
  userId       String   @unique
  accessToken  String   @db.Text
  refreshToken String   @db.Text
  expiresAt    DateTime
  mlUserId     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("mercadolivreauth")
}

model AliExpressAuth {
  id           String    @id @default(cuid())
  userId       String    @unique
  appKey       String
  appSecret    String    @db.Text
  accessToken  String?   @db.Text
  refreshToken String?   @db.Text
  expiresAt    DateTime?
  trackingId   String?
  sellerId     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("aliexpressauth")
}

model ShopeeAuth {
  id           String   @id @default(cuid())
  userId       String   @unique
  partnerId    Int
  partnerKey   String
  accessToken  String   @db.Text
  refreshToken String   @db.Text
  shopId       Int
  merchantName String?
  region       String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("shopeeauth")
}

model TikTokShopAuth {
  id                   String    @id @default(cuid())
  userId               String    @unique
  appKey               String
  appSecret            String    @db.Text
  accessToken          String?   @db.Text
  refreshToken         String?   @db.Text
  accessTokenExpireIn  Int?
  refreshTokenExpireIn Int?
  shopId               String?
  shopName             String?
  shopCipher           String?   @db.Text
  openId               String?
  sellerName           String?
  region               String?   @default("BR")
  expiresAt            DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("tiktokshopauth")
}

model MarketplaceListing {
  id           String    @id @default(cuid())
  productId    String
  marketplace  String
  listingId    String
  status       String
  title        String?
  price        Float?
  stock        Int?
  listingUrl   String?   @db.Text
  lastSyncAt   DateTime?
  syncEnabled  Boolean   @default(true)
  errorMessage String?   @db.Text
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  product      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, marketplace])
  @@index([marketplace])
  @@index([status])
  @@map("marketplacelisting")
}

model CompanySettings {
  id                            String   @id @default(cuid())
  name                          String?
  cnpj                          String?
  email                         String?
  phone                         String?
  address                       String?  @db.Text
  defaultCommission             Float?   @default(10)
  processingDays                Int?     @default(2)
  showRealTimeStock             Boolean  @default(true)
  autoApproveSellers            Boolean  @default(false)
  notifyNewDropshippingProducts Boolean  @default(true)
  createdAt                     DateTime @default(now())
  updatedAt                     DateTime @updatedAt

  @@map("company_settings")
}

model MercadoLivreCredentials {
  id           String   @id @default(cuid())
  clientId     String
  clientSecret String   @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("mercadolivrecredentials")
}

model Plan {
  id                        String         @id @default(cuid())
  name                      String
  description               String?        @db.Text
  price                     Float
  billingCycle              BillingCycle
  maxProducts               Int?
  maxOrders                 Int?
  maxRevenue                Float?
  hasMarketplaceIntegration Boolean        @default(false)
  hasDropshipping           Boolean        @default(false)
  hasAdvancedAnalytics      Boolean        @default(false)
  hasCustomBranding         Boolean        @default(false)
  hasPrioritySupport        Boolean        @default(false)
  platformCommission        Float          @default(10)
  isActive                  Boolean        @default(true)
  isPopular                 Boolean        @default(false)
  hasFreeTrial              Boolean        @default(false)
  trialDays                 Int?
  createdAt                 DateTime       @default(now())
  updatedAt                 DateTime       @updatedAt
  subscriptions             Subscription[]

  @@map("plan")
}

model Subscription {
  id              String             @id @default(cuid())
  sellerId        String             @unique
  planId          String
  status          SubscriptionStatus @default(TRIAL)
  startDate       DateTime           @default(now())
  endDate         DateTime
  trialEndDate    DateTime?
  cancelledAt     DateTime?
  price           Float
  billingCycle    BillingCycle
  nextBillingDate DateTime?
  autoRenew       Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  plan            Plan               @relation(fields: [planId], references: [id])
  seller          Seller             @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([endDate])
  @@index([nextBillingDate])
  @@index([planId], map: "subscription_planId_fkey")
  @@map("subscription")
}

model ProductType {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  icon        String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("product_type")
}

model PaymentGateway {
  id        String   @id @default(cuid())
  gateway   String   @unique
  isActive  Boolean  @default(false)
  config    String   @db.LongText
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payment_gateway")
}

model Refund {
  id          String       @id @default(cuid())
  orderId     String
  paymentId   String
  refundId    String?
  amount      Float
  reason      String?      @db.Text
  gateway     String
  status      String
  processedBy String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  order       Order        @relation(fields: [orderId], references: [id])
  items       RefundItem[]

  @@index([orderId])
  @@index([paymentId])
  @@map("refund")
}

model RefundItem {
  id          String    @id @default(cuid())
  refundId    String
  orderItemId String
  amount      Float
  createdAt   DateTime  @default(now())
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id])
  refund      Refund    @relation(fields: [refundId], references: [id])

  @@index([refundId])
  @@index([orderItemId])
  @@map("refund_item")
}

model Withdrawal {
  id              String           @id @default(cuid())
  sellerId        String
  amount          Float
  status          WithdrawalStatus @default(PENDING)
  paymentMethod   String
  pixKey          String?
  pixKeyType      String?
  bankName        String?
  bankCode        String?
  agencia         String?
  conta           String?
  contaTipo       String?
  transactionId   String?
  processedAt     DateTime?
  processedBy     String?
  rejectionReason String?          @db.Text
  sellerNote      String?          @db.Text
  adminNote       String?          @db.Text
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  seller          Seller           @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([sellerId])
  @@index([status])
  @@index([createdAt])
  @@map("withdrawal")
}

model ApiLog {
  id           String   @id @default(cuid())
  method       String
  endpoint     String
  statusCode   Int
  userId       String?
  userRole     String?
  sellerId     String?
  sellerName   String?
  requestBody  String?  @db.Text
  responseBody String?  @db.Text
  errorMessage String?  @db.Text
  ipAddress    String?
  userAgent    String?  @db.Text
  duration     Int?
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([sellerId])
  @@index([method])
  @@index([endpoint])
  @@index([statusCode])
  @@index([createdAt])
  @@map("api_log")
}

model prisma_migrations_itemtype {
  value String @id

  @@map("_prisma_migrations_itemtype")
}

model ShippingRule {
  id              String   @id @default(cuid())
  name            String
  description     String?
  regionType      String
  regions         String   @db.Text
  minWeight       Float?
  maxWeight       Float?
  shippingCost    Float
  costPerKg       Float?
  freeShippingMin Float?
  deliveryDays    Int
  isActive        Boolean  @default(true)
  priority        Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  minCartValue    Float?
  maxCartValue    Float?

  @@index([isActive])
  @@index([regionType])
  @@index([priority])
  @@map("shippingrule")
}

model PackagingBox {
  id          String        @id @default(cuid())
  name        String
  code        String        @unique
  type        PackagingType @default(BOX)
  innerLength Float
  innerWidth  Float
  innerHeight Float
  outerLength Float
  outerWidth  Float
  outerHeight Float
  emptyWeight Float
  maxWeight   Float
  maxVolume   Float?
  cost        Float         @default(0)
  isActive    Boolean       @default(true)
  isDefault   Boolean       @default(false)
  priority    Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([isActive])
  @@index([type])
  @@index([priority])
  @@map("packagingbox")
}

model ShippingCarrier {
  id           String              @id @default(cuid())
  code         String              @unique
  name         String
  type         ShippingCarrierType @default(CARRIER)
  logo         String?
  color        String?
  isActive     Boolean             @default(true)
  isDefault    Boolean             @default(false)
  apiUrl       String?
  apiKey       String?
  apiSecret    String?
  apiToken     String?             @db.Text
  apiConfig    String?             @db.Text
  contractCode String?
  adminCode    String?
  username     String?
  password     String?
  senderCNPJ   String?
  senderCEP    String?
  labelFormat  String?             @default("PDF")
  labelWidth   Float?
  labelHeight  Float?
  trackingUrl  String?
  priority     Int                 @default(0)
  minWeight    Float?
  maxWeight    Float?
  maxLength    Float?
  maxWidth     Float?
  maxHeight    Float?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  services     ShippingService[]

  @@index([isActive])
  @@index([code])
  @@map("shippingcarrier")
}

model ShippingService {
  id             String          @id @default(cuid())
  carrierId      String
  code           String
  name           String
  description    String?
  minDays        Int?
  maxDays        Int?
  additionalDays Int?            @default(0)
  baseCost       Float?
  costPerKg      Float?
  percentageFee  Float?
  isActive       Boolean         @default(true)
  maxWeight      Float?
  maxValue       Float?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  carrier        ShippingCarrier @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  @@unique([carrierId, code])
  @@index([carrierId])
  @@index([isActive])
  @@map("shippingservice")
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  category    String
  label       String
  description String?  @db.Text
  type        String   @default("text")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([key])
  @@map("systemconfig")
}

model analytics_table {
  id          String   @id
  name        String
  description String?  @db.Text
  data        String   @db.LongText
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([createdAt])
  @@index([name])
}

enum EmployeeRole {
  MANAGER
  OPERATOR
  VIEWER

  @@map("user_employeeRole")
}

enum Role {
  USER
  ADMIN
  SELLER

  @@map("user_role")
}

enum SellerType {
  PF
  PJ

  @@map("seller_sellerType")
}

enum SellerStatus {
  PENDING
  ACTIVE
  SUSPENDED
  REJECTED

  @@map("seller_status")
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED

  @@map("order_status")
}

enum ItemType {
  DROPSHIPPING
  STOCK

  @@map("orderitem_itemType")
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  SEMIANNUAL
  ANNUAL
}

enum SubscriptionStatus {
  PENDING_PAYMENT
  TRIAL
  ACTIVE
  EXPIRED
  CANCELLED
  SUSPENDED
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  REJECTED
  CANCELLED

  @@map("withdrawal_status")
}

enum ShippingCarrierType {
  OWN
  CARRIER
  POSTAL
  AGGREGATOR
}

enum PackagingType {
  BOX
  ENVELOPE
  TUBE
  BAG
  CUSTOM
}
